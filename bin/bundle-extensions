#!/usr/bin/env python
import os
from distutils.dir_util import copy_tree

import importlib_metadata
import importlib_resources

from redash.extensions import BUNDLE_DIRECTORY, resource_isdir, entry_point_module


# Make a directory for extensions and set it as an environment variable
# to be picked up by webpack.
EXTENSIONS_RELATIVE_PATH = os.path.join('client', 'app', 'extensions')
EXTENSIONS_DIRECTORY = os.path.join(
    os.path.dirname(os.path.dirname(__file__)),
    EXTENSIONS_RELATIVE_PATH)

if not os.path.exists(EXTENSIONS_DIRECTORY):
    os.makedirs(EXTENSIONS_DIRECTORY)
os.environ["EXTENSIONS_DIRECTORY"] = EXTENSIONS_RELATIVE_PATH


for entry_point in importlib_metadata.entry_points().get('redash.extensions', []):
    # Check if there is a "bundle" subdirectory/-package in the
    # entrypoint's module and ignoring the entrypoint if not.
    module = entry_point_module(entry_point)
    if not resource_isdir(module, BUNDLE_DIRECTORY):
        continue

    # The destination for the bundle files with the entry point name as the subdirectory
    destination = os.path.join(EXTENSIONS_DIRECTORY, entry_point.name)
    # Copy the bundle directory from the module to its destination.
    with importlib_resources.path(module, BUNDLE_DIRECTORY) as bundle_dir:
        print("Copying {} to {}".format(bundle_dir, destination))
        copy_tree(str(bundle_dir), destination)
